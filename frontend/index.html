<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CatSpy ‚Äî Phishing & Deepfake Detection</title>
  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#6366f1;
      --accent-light:#818cf8;
      --accent-dark:#4f46e5;
      --danger:#ef4444;
      --danger-light:#fca5a5;
      --safe:#10b981;
      --safe-light:#6ee7b7;
      --warn:#f59e0b;
      --warn-light:#fbbf24;
      --border:#e2e8f0;
      --chip:#f1f5f9;
      --shadow-sm:0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --gradient-primary:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-success:linear-gradient(135deg, #10b981 0%, #059669 100%);
      --gradient-warning:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --gradient-danger:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter:saturate(180%) blur(6px);
      background:rgba(255,255,255,0.8);
      border-bottom:1px solid var(--border);
    }
    .nav{
      max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:10px 16px;
    }
    .brand{ font-weight:700; letter-spacing:.2px; }
    .brand span{ color:var(--accent);}
    nav a{
      margin:0 10px; text-decoration:none; color:var(--text); padding:8px 10px; border-radius:8px;
    }
    nav a.active, nav a:hover{ background:var(--chip); color:var(--accent); }
    main{ max-width:1100px; margin:12px auto; padding:0 16px 30px; }
    .grid{
      display:grid; grid-template-columns:repeat(12,1fr); gap:12px;
    }
    .card{
      grid-column:span 12; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:var(--shadow-sm); transition:box-shadow 0.2s ease;
    }
    .card:hover{
      box-shadow:var(--shadow-md);
    }
    @media (min-width:800px){
      .span-4{ grid-column:span 4;}
      .span-6{ grid-column:span 6;}
      .span-8{ grid-column:span 8;}
    }
    h1{ margin:6px 0 10px; font-size:24px;}
    h2{ margin:0 0 8px; font-size:18px;}
    p.muted{ color:var(--muted); margin-top:4px;}
    .btn{
      background:var(--accent); color:#fff; border:none; border-radius:10px; padding:8px 14px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:var(--shadow-sm);
    }
    .btn:hover:not(:disabled){ background:var(--accent-dark); box-shadow:var(--shadow-md); transform:translateY(-1px); }
    .btn:active:not(:disabled){ transform:translateY(0); box-shadow:var(--shadow-sm); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .btn.secondary{ background:var(--gradient-primary); }
    .btn.secondary:hover:not(:disabled){ background:linear-gradient(135deg, #5a67d8 0%, #6b5b95 100%); }
    .btn.ghost{ background:transparent; color:var(--accent); border:2px solid var(--accent); }
    .btn.ghost:hover:not(:disabled){ background:var(--accent); color:#fff; }
    .btn-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    textarea, input[type="text"], input[type="file"], select{
      width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
    }
    .kpi{ display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:var(--card); }
    .kpi b{ font-size:18px; }
    .badge{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--chip); color:var(--accent); }
    .result{
      border-radius:14px; padding:10px; border:1px dashed var(--border); background:#fafafa;
    }
    .pill{ display:inline-block; padding:6px 14px; border-radius:999px; font-size:12px; font-weight:600; letter-spacing:0.3px; box-shadow:var(--shadow-sm); }
    .pill.safe{ background:#d1fae5; color:#065f46; border:1px solid #6ee7b7; }
    .pill.suspicious{ background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
    .pill.danger{ background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
    .result{ animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn{ from{ opacity:0; transform:translateY(-10px); } to{ opacity:1; transform:translateY(0); } }
    .hr{ height:1px; background:var(--border); margin:8px 0; }
    .list{ list-style:none; padding:0; margin:0;}
    .list li{ display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border); }
    .footer{
      text-align:center; color:var(--muted); padding:20px 0; font-size:13px;
    }
    .chip{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hide{ display:none !important; }
  .logo-mark{ height:56px; width:56px; border-radius:16px; border:1px solid var(--border); background:#fff; padding:6px; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand" style="display:flex;align-items:center;gap:10px;">
  <img src="catspy-logo.png" data-logo="catspy-logo.png" alt="CatSpy Logo" style="height:40px;width:40px;vertical-align:middle;">
        <span style="font-weight:700;font-size:1.25em;">CatSpy</span>
      </div>
      <nav>
        <a href="#/" id="nav-home">Home</a>
        <a href="#/phishing" id="nav-phish">Phishing/URL</a>
        <a href="#/email" id="nav-email">Email Security</a>
        <a href="#/deepfake" id="nav-deep">Deepfake</a>
        <a href="#/reports" id="nav-reports">Reports</a>
      </nav>
    </div>
  </header>
  <main>
    <!-- HOME -->
    <section id="view-home" class="grid">
      <div class="card span-8">
        <div style="display:flex; align-items:center; gap:14px;">
          <img class="logo-mark" src="catspy-logo.png" data-logo="catspy-logo.png" alt="CatSpy logo"/>
          <h1 style="margin:0;">Welcome üëã</h1>
        </div>
        <p class="muted" style="margin-top:12px;">One place for phishing detection, email scanning, and deepfake analysis. Pick a module to start.</p>
        <div class="grid" style="margin-top:10px;">
          <div class="card span-4">
            <h2>Phishing / URL Detector</h2>
            <p class="muted">Paste text or URL, we‚Äôll highlight risks.</p>
            <div class="btn-row">
              <a class="btn" href="#/phishing">Open</a>
              <span class="badge">NLP + Heuristics</span>
            </div>
          </div>
          <div class="card span-4">
            <h2>Email Security</h2>
            <p class="muted">Scan inbox, spot suspicious senders & links.</p>
            <div class="btn-row">
              <a class="btn" href="#/email">Open</a>
              <span class="badge">Metrics & Charts</span>
            </div>
          </div>
          <div class="card span-4">
            <h2>Deepfake Analyzer</h2>
            <p class="muted">Upload a video frame / face image to check authenticity.</p>
            <div class="btn-row">
              <a class="btn" href="#/deepfake">Open</a>
              <span class="badge">Vision / CNN</span>
            </div>
          </div>
        </div>
      </div>
      <div class="span-4">
        <div class="kpi"><b>97%</b> Avg detection accuracy (demo)</div>
        <div class="kpi"><b>+3</b> Threat vectors protected</div>
        <div class="kpi"><b><span id="kpi-scans">0</span></b> Scans this session</div>
        <div class="card">
          <h2>Quick Tips</h2>
          <ul class="list">
            <li><span>Hover links to preview the real domain</span> <span class="chip">Phishing</span></li>
            <li><span>Verify sender domain alignment (SPF/DKIM)</span> <span class="chip">Email</span></li>
            <li><span>Check eye/reflection/edges for artifacts</span> <span class="chip">Deepfake</span></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- PHISHING / URL -->
    <section id="view-phishing" class="grid hide">
      <div class="card span-8">
        <h1>Phishing / URL Detector</h1>
        <p class="muted">Paste a message or a URL. This demo uses mock analysis to illustrate the UI behavior.</p>
        <label for="phish-input"><b>üìù Content / URL to Analyze</b></label>
        <textarea id="phish-input" rows="8" placeholder="Paste any suspicious message, email content, or URL here for analysis...

Examples:
‚Ä¢ Email: &quot;Your account will be suspended! Verify now at...&quot;
‚Ä¢ URL: http://suspicious-website.com
‚Ä¢ Message: &quot;Click here to claim your prize!&quot;"></textarea>
        <div class="btn-row" style="margin-top:10px;">
          <button class="btn" id="btn-analyze" style="display:flex;align-items:center;gap:6px;">
            <span>üîç</span> Run Analysis
          </button>
          <button class="btn ghost" id="btn-clear">Clear</button>
        </div>
        <div class="hr"></div>
        <div id="phish-result" class="result hide">
          <div style="display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:10px;">
              <b style="font-size:16px;">Analysis Result</b> 
              <span id="phish-level" class="pill" style="font-weight:600;">Pending</span>
            </div>
            <div style="text-align:right;">
              <div class="muted" style="font-size:12px;">Risk Score</div>
              <div style="font-size:24px; font-weight:700; line-height:1;"><span id="phish-score">‚Äî</span><span style="font-size:14px;color:var(--muted);">/100</span></div>
            </div>
          </div>
          <div class="hr"></div>
          <div id="phish-findings"></div>
        </div>
      </div>
      <div class="card span-4">
        <h2>üîç Security Checks</h2>
        <p class="muted" style="margin-bottom:12px;font-size:13px;">Multi-layer analysis results</p>
        <ul class="list">
          <li><span>üåê Domain Risk</span> <span id="h-domain">‚Äî</span></li>
          <li><span>‚ö° Urgency Tactics</span> <span id="h-urgency">‚Äî</span></li>
          <li><span>üîê Credential Request</span> <span id="h-creds">‚Äî</span></li>
          <li><span>üîó URL Obfuscation</span> <span id="h-short">‚Äî</span></li>
          <li><span>üé≠ Brand Spoofing</span> <span id="h-brand">‚Äî</span></li>
        </ul>
      </div>
    </section>

    <!-- EMAIL SECURITY -->
    <section id="view-email" class="grid hide">
      <div class="card span-12">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <h1 style="margin:0;">Email Security Dashboard</h1>
            <p class="muted" style="margin-top:6px;">AI-powered phishing detection with real-time monitoring</p>
          </div>
          <div style="text-align:right;">
            <div class="badge" id="email-status-badge">System Status</div>
            <div class="muted" style="font-size:12px;margin-top:4px;" id="email-data-source">Loading...</div>
          </div>
        </div>
        <div id="gmail-account-info" class="hide" style="background:var(--gradient-primary);padding:18px;border-radius:14px;margin-bottom:18px;color:#fff;box-shadow:var(--shadow-md);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="background:rgba(255,255,255,0.2);padding:12px;border-radius:10px;font-size:24px;">üìß</div>
            <div style="flex:1;">
              <div style="font-size:13px;opacity:0.9;">Connected Gmail Account</div>
              <div style="font-size:18px;font-weight:600;margin-top:2px;" id="gmail-email-display">‚Äî</div>
            </div>
            <div style="text-align:center;background:rgba(255,255,255,0.15);padding:10px 16px;border-radius:10px;">
              <div style="font-size:20px;font-weight:700;" id="gmail-messages-count">‚Äî</div>
              <div style="font-size:11px;opacity:0.8;">Total Messages</div>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;">
          <div style="flex:1;min-width:250px;">
            <label style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text);">
              üìä Number of Emails to Scan
            </label>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
              <input type="number" id="scan-limit" value="100" min="10" max="500" step="10" 
                style="width:110px;padding:10px;border:2px solid var(--accent);border-radius:10px;font-size:15px;font-weight:700;text-align:center;color:var(--accent);">
              <button onclick="document.getElementById('scan-limit').value=50" class="chip" style="cursor:pointer;border:1px solid var(--border);">50</button>
              <button onclick="document.getElementById('scan-limit').value=100" class="chip" style="cursor:pointer;border:1px solid var(--border);">100</button>
              <button onclick="document.getElementById('scan-limit').value=200" class="chip" style="cursor:pointer;border:1px solid var(--border);">200</button>
              <button onclick="document.getElementById('scan-limit').value=500" class="chip" style="cursor:pointer;border:1px solid var(--border);">500</button>
              <span class="muted" style="font-size:12px;">(max: 500)</span>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn" id="btn-scan-emails" style="font-size:14px;padding:12px 18px;">üîç Start Scan</button>
            <button class="btn ghost" id="btn-scan-all" style="font-size:14px;padding:12px 18px;">üìß Scan All (500)</button>
            <button class="btn secondary" id="btn-load-test-data" style="font-size:14px;padding:12px 18px;background:var(--gradient-warning);color:#fff;border:none;">üß™ Test Data (60)</button>
            <span class="badge" id="email-model-badge">DistilBERT + LoRA</span>
          </div>
        </div>
        
        <!-- Scanning Progress Bar -->
        <div id="scan-progress-container" class="hide" style="margin-top:18px;padding:18px;background:var(--gradient-primary);border-radius:14px;color:#fff;box-shadow:var(--shadow-md);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div>
              <div style="font-size:16px;font-weight:600;">üîÑ Scanning in progress...</div>
              <div style="font-size:13px;opacity:0.9;margin-top:4px;" id="scan-progress-text">Initializing...</div>
            </div>
            <div style="font-size:24px;font-weight:700;" id="scan-progress-percent">0%</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);border-radius:999px;height:8px;overflow:hidden;">
            <div id="scan-progress-bar" style="background:#fff;height:100%;width:0%;transition:width 0.3s ease;border-radius:999px;"></div>
          </div>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="card span-3">
        <div style="text-align:center;">
          <div class="muted" style="font-size:13px;">Total Emails</div>
          <div style="font-size:32px;font-weight:700;margin:8px 0;" id="em-total">0</div>
          <div class="chip">üìß</div>
        </div>
      </div>
      <div class="card span-3">
        <div style="text-align:center;">
          <div class="muted" style="font-size:13px;">Suspicious</div>
          <div style="font-size:32px;font-weight:700;margin:8px 0;color:#d97706;" id="em-suspicious">0</div>
          <div class="pill suspicious">‚ö†Ô∏è Risk</div>
        </div>
      </div>
      <div class="card span-3">
        <div style="text-align:center;">
          <div class="muted" style="font-size:13px;">High Risk</div>
          <div style="font-size:32px;font-weight:700;margin:8px 0;color:#dc2626;" id="em-high-risk">0</div>
          <div class="pill danger">üö® Critical</div>
        </div>
      </div>
      <div class="card span-3">
        <div style="text-align:center;">
          <div class="muted" style="font-size:13px;">Detection Rate</div>
          <div style="font-size:32px;font-weight:700;margin:8px 0;color:#16a34a;" id="em-detection-rate">96.4%</div>
          <div class="pill safe">‚úì Model</div>
          <div class="muted" style="font-size:11px;margin-top:8px;opacity:0.7;">Medium + High Risk</div>
        </div>
      </div>

      <div class="card span-6">
        <h2>Risk Level Distribution</h2>
        <ul class="list" id="email-risk-levels">
          <li><span>Low</span><b id="risk-low">0</b></li>
          <li><span>Medium</span><b id="risk-medium">0</b></li>
          <li><span>High</span><b id="risk-high">0</b></li>
        </ul>
      </div>

      <div class="card span-6">
        <h2>Category Distribution</h2>
        <ul class="list" id="email-categories">
          <li><span>üé£ Phishing</span><b id="cat-phishing">0</b></li>
          <li><span>üìÆ Spam</span><b id="cat-spam">0</b></li>
          <li><span>ü¶† Malware</span><b id="cat-malware">0</b></li>
          <li><span>‚úì Normal</span><b id="cat-normal">0</b></li>
        </ul>
      </div>

      <!-- Threat Report (Collapsible) -->
      <div class="card span-12">
        <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="document.getElementById('email-threats-list').classList.toggle('hide');this.querySelector('.toggle-icon').textContent=document.getElementById('email-threats-list').classList.contains('hide')?'‚ñº':'‚ñ≤';">
          <h2>üö® Threat Detection Report</h2>
          <span class="toggle-icon" style="font-size:18px;color:var(--muted);">‚ñ≤</span>
        </div>
        <div class="hr"></div>
        <div id="email-threats-list">
          <p class="muted" style="text-align:center;padding:40px;">üìä Click "Start Scan" or "Test Data (50)" to begin analysis</p>
        </div>
      </div>
    </section>

    <!-- DEEPFAKE -->
    <section id="view-deepfake" class="grid hide">
      <div class="card span-8">
        <h1>Deepfake Analyzer</h1>
        <p class="muted">Upload a face image (or video frame). This preview simulates a classifier's output.</p>
        <label for="df-file"><b>Upload Image</b></label>
        <input id="df-file" type="file" accept="image/*"/>
        <div class="btn-row" style="margin-top:10px;">
          <button class="btn" id="btn-df-analyze">Analyze</button>
          <button class="btn ghost" id="btn-df-clear">Clear</button>
        </div>
        <div id="df-preview" class="result hide" style="margin-top:10px;">
          <div style="display:flex; gap:14px; align-items:flex-start;">
            <img id="df-img" src="" alt="preview" style="max-width:160px; border-radius:10px; border:1px solid var(--border)"/>
            <div>
              <div><b>Authenticity</b> <span id="df-level" class="pill">‚Äî</span></div>
              <p class="muted" style="margin:6px 0 10px;">Confidence: <b id="df-score">‚Äî</b></p>
              <ul class="list" id="df-findings">
                <li><span class="muted">No findings yet</span><span></span></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card span-4">
        <h2>What we check</h2>
        <ul class="list">
          <li><span>Edge artifacts (hair/ears/teeth)</span><span class="chip">Texture</span></li>
          <li><span>Frequency cues</span><span class="chip">FFT</span></li>
          <li><span>Face consistency</span><span class="chip">Landmarks</span></li>
          <li><span>Noise signature</span><span class="chip">PRNU</span></li>
        </ul>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="view-reports" class="grid hide">
      <div class="card span-8">
        <h1>Reports</h1>
        <p class="muted">Consolidated results from Phishing, Email, and Deepfake modules (demo data).</p>
        <div class="grid">
          <div class="card span-6">
            <h2>Summary</h2>
            <ul class="list">
              <li><span>Total scans</span><b id="r-scans">0</b></li>
              <li><span>Suspicious URLs</span><b id="r-urls">0</b></li>
              <li><span>Risky senders</span><b id="r-senders">0</b></li>
              <li><span>Likely deepfakes</span><b id="r-deep">0</b></li>
            </ul>
          </div>
          <div class="card span-6">
            <h2>Recent Alerts</h2>
            <ul class="list" id="r-alerts">
              <li><span class="muted">No alerts</span><span></span></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card span-4">
        <h2>Export</h2>
        <p class="muted">Download your report as JSON for integration.</p>
        <div class="btn-row">
          <button class="btn" id="btn-json">Download JSON</button>
        </div>
      </div>
    </section>
  <div class="footer">¬© 2025 CatSpy ‚Äî Prototype Preview</div>
  </main>

  <script>
    // Simple SPA Router
    const routes = ["home","phishing","email","deepfake","reports"];
    const navIds = {
      "home": "nav-home",
      "phishing": "nav-phish",
      "email": "nav-email",
      "deepfake": "nav-deep",
      "reports": "nav-reports"
    };
    function route(){
      const hash = location.hash.replace("#/","") || "";
      const current = routes.includes(hash) ? hash : "home";
      routes.forEach(r=>{
        const viewEl = document.getElementById("view-"+r);
        if (viewEl) viewEl.classList.toggle("hide", r!==current);
        const navEl = document.getElementById(navIds[r]);
        if (navEl) navEl.classList.toggle("active", r===current);
      });
      
      // Load email data when navigating to email page
      if(current === "email") {
        loadEmailStatus();
        loadEmailSummary();
        loadEmailThreats();
      }
      
      // Load report data when navigating to reports page
      if(current === "reports") {
        loadReportData();
      }
    }
    window.addEventListener("hashchange", route);
    window.addEventListener("load", route);

    // Demo state
    const state = {
      scans:0, urls:0, senders:0, deepfakes:0,
      alerts:[],
      email:{ new:0, sus:0, blk:0, senders:[] }
    };
    const $ = s=>document.querySelector(s);

    function resolveBackendOrigin(){
      const locOrigin = window.location.origin;
      if(!locOrigin || locOrigin === 'null' || locOrigin.startsWith('file:')){
        return 'http://127.0.0.1:8000';
      }
      return locOrigin;
    }

    document.querySelectorAll('[data-logo]').forEach(img=>{
      const asset = img.dataset.logo;
      if(asset){
        try{
          img.src = `${resolveBackendOrigin()}/static/${asset}`;
        }catch(err){
          console.error('Failed to resolve logo asset', err);
        }
      }
    });

    function rerenderKPIs(){
      const kpiScans = $("#kpi-scans");
      if (kpiScans) kpiScans.textContent = state.scans;
      const rScans = $("#r-scans");
      if (rScans) rScans.textContent = state.scans;
      const rUrls = $("#r-urls");
      if (rUrls) rUrls.textContent = state.urls;
      const rSenders = $("#r-senders");
      if (rSenders) rSenders.textContent = state.senders;
      const rDeep = $("#r-deep");
      if (rDeep) rDeep.textContent = state.deepfakes;
      const rlist = $("#r-alerts");
      if (rlist) {
        rlist.innerHTML = state.alerts.length ? "" : '<li><span class="muted">No alerts</span><span></span></li>';
        state.alerts.slice(-5).reverse().forEach(a=>{
          const li = document.createElement("li");
          li.innerHTML = `<span>${a}</span><span class="pill ${a.includes('Deepfake')?'danger':'suspicious'}">${a.includes('Deepfake')?'High':'Medium'}</span>`;
          rlist.appendChild(li);
        });
      }
      const emNew = $("#em-new");
      if (emNew) emNew.textContent = state.email.new;
      const emSus = $("#em-sus");
      if (emSus) emSus.textContent = state.email.sus;
      const emBlk = $("#em-blk");
      if (emBlk) emBlk.textContent = state.email.blk;
      const sl = $("#em-senders");
      if (sl) {
        sl.innerHTML = state.email.senders.length ? "" : '<li><span class="muted">No data</span><span></span></li>';
        state.email.senders.forEach(s=>{
          const li = document.createElement("li");
          li.innerHTML = `<span>${s.name}</span><span class="pill suspicious">${s.count}</span>`;
          sl.appendChild(li);
        });
      }
    }

    // Phishing analysis (calls backend /predict; falls back to mock on failure)
    $("#btn-analyze").addEventListener("click", async ()=>{
      const text = $("#phish-input").value.trim();
      if(!text){ alert("Paste some text or a URL first."); return; }
      $("#phish-result").classList.remove("hide");
      const pill = $("#phish-level");
      pill.className = "pill";
      pill.textContent = "ANALYZING...";
      $("#phish-score").textContent = "‚Ä¶";
      $("#phish-findings").innerHTML = "<p class='muted'>Analyzing‚Ä¶</p>";

      try{
  const resp = await fetch(`${resolveBackendOrigin()}/predict`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text })
        });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error(`Server returned ${resp.status}: ${txt}`);
        }
        const data = await resp.json();

        const levelClass = data.result === 'PHISHING' ? 'danger' : (data.result === 'SUSPICIOUS' ? 'suspicious' : 'safe');
        pill.className = 'pill ' + levelClass;
        pill.textContent = data.result;
        $("#phish-score").textContent = data.score;

        const h = data.heuristics || {};
        const formatHeuristic = (val) => {
          if (!val || val === 'none' || val === 'ok') return '<span class="badge" style="background:#ecfdf5;color:#16a34a;border-color:#a7f3d0">‚úì OK</span>';
          if (val === 'low' || val === 'maybe' || val === 'possible') return '<span class="badge" style="background:#fff7ed;color:#d97706;border-color:#fed7aa">‚ö† Low</span>';
          return '<span class="badge" style="background:#fef2f2;color:#dc2626;border-color:#fecaca">‚ö† High</span>';
        };
        $("#h-domain").innerHTML = formatHeuristic(h.domain_risk);
        $("#h-urgency").innerHTML = formatHeuristic(h.urgency_language);
        $("#h-creds").innerHTML = formatHeuristic(h.creds_request);
        $("#h-short").innerHTML = formatHeuristic(h.shortener_obfuscation);
        $("#h-brand").innerHTML = formatHeuristic(h.brand_spoof);

        // Display findings with better formatting
        const fwrap = $("#phish-findings");
        let findingsHTML = '';
        
        // Show model confidence
        if (data.model && data.model.confidence) {
          findingsHTML += `<div style="margin-bottom:12px;padding:10px;background:#f9fafb;border-radius:8px;">`;
          findingsHTML += `<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><b>ü§ñ AI Model Analysis</b><span class="badge">Confidence: ${data.confidence || 0}%</span></div>`;
          findingsHTML += `<div style="display:flex;gap:20px;font-size:13px;">`;
          findingsHTML += `<span>Safe: <b style="color:#16a34a">${data.model.confidence.safe}%</b></span>`;
          findingsHTML += `<span>Phishing: <b style="color:#dc2626">${data.model.confidence.phishing}%</b></span>`;
          findingsHTML += `</div></div>`;
        }
        
        // Show risk indicators with icons
        const risks = data.risk_indicators || [];
        if (risks.length > 0) {
          findingsHTML += '<div style="margin-top:10px;"><b>‚ö†Ô∏è Risk Indicators:</b><ul class="list" style="margin-top:8px;">';
          risks.forEach(r => {
            const icon = r.severity === 'high' ? 'üî¥' : 'üü°';
            findingsHTML += `<li><span>${icon} ${r.text}</span><span class="chip" style="font-size:11px;">${r.type}</span></li>`;
          });
          findingsHTML += '</ul></div>';
        }
        
        // Show detailed cues
        const cues = data.cues || [];
        if (cues.length > 0) {
          findingsHTML += '<div style="margin-top:10px;"><b>üîç Detected Elements:</b><ul class="list" style="margin-top:8px;">';
          cues.forEach(c => {
            let text = '';
            if(c.type === 'url') text = `Link: ${c.details && c.details.domain ? c.details.domain : c.text}`;
            else if(c.type === 'keyword') text = `Keywords: ${c.text}`;
            else if(c.type === 'credential_request') text = `Credential request: ${c.text}`;
            else if(c.type === 'brand') text = `Brand: ${c.text}`;
            else text = c.text || JSON.stringify(c);
            findingsHTML += `<li><span>${text}</span><span class="chip" style="font-size:11px;">${c.type}</span></li>`;
          });
          findingsHTML += '</ul></div>';
        }
        
        fwrap.innerHTML = findingsHTML || '<p class="muted" style="text-align:center;padding:20px;">‚úì No threats detected</p>';

        state.scans++;
        state.urls += (data.result !== 'SAFE') ? 1 : 0;
        if(data.result !== 'SAFE') state.alerts.push('Phishing risk detected ('+data.result+')');
        rerenderKPIs();
      }catch(err){
        console.error(err);
        const fallbackMsg = 'Backend unavailable, using local heuristics.';
        $("#phish-findings").innerHTML = `<p class='muted'>${fallbackMsg}</p>`;
        // Fallback: original mock scoring
        const cues = {
          domain:/http(s)?:\/\//i.test(text) ? 1 : 0,
          urgency: /(urgent|immediately|now|locked|verify)/i.test(text) ? 1 : 0,
          creds: /(password|bank|otp|account)/i.test(text) ? 1 : 0,
          short: /(bit\.ly|t\.co|tinyurl|goo\.gl)/i.test(text) ? 1 : 0,
          brand: /(paypal|bank|apple|microsoft)/i.test(text) ? 1 : 0,
        };
        const score = (cues.domain*18 + cues.urgency*28 + cues.creds*28 + cues.short*12 + cues.brand*14);
        let level = 'safe';
        if(score >= 60) level = 'danger';
        else if(score >= 30) level = 'suspicious';

        const pill2 = $("#phish-level");
        pill2.className = 'pill ' + level;
        pill2.textContent = level.toUpperCase();
        $("#phish-score").textContent = score.toFixed(0);
        $("#h-domain").textContent = cues.domain? 'risk' : 'ok';
        $("#h-urgency").textContent = cues.urgency? 'present' : 'none';
        $("#h-creds").textContent = cues.creds? 'present' : 'none';
        $("#h-short").textContent = cues.short? 'present' : 'none';
        $("#h-brand").textContent = cues.brand? 'suspected' : '‚Äî';

        const findings = [
          cues.domain? 'Contains link ‚Äî validate domain ownership' : null,
          cues.urgency? 'Uses urgency language' : null,
          cues.creds? 'Requests credentials/financial info' : null,
          cues.short? 'Uses URL shortener / obfuscation' : null,
          cues.brand? 'Possible brand spoofing' : null,
        ].filter(Boolean);
        const fwrap2 = $("#phish-findings");
        fwrap2.innerHTML = findings.length ? "<ul class='list'>" + findings.map(f=>`<li><span>${f}</span><span></span></li>`).join("") + "</ul>" : "<p class='muted'>No risky cues found.</p>";

        state.scans++; state.urls += (level!=='safe'); 
        if(level!=='safe') state.alerts.push('Phishing risk detected ('+level+')');
        rerenderKPIs();
      }
    });

    $("#btn-clear").addEventListener("click", ()=>{
      $("#phish-input").value = "";
      $("#phish-result").classList.add("hide");
    });

    // Email Security
    let emailData = { summary: null, threats: [] };

    async function loadEmailStatus() {
      try {
        const resp = await fetch(`${resolveBackendOrigin()}/api/status`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        const status = await resp.json();
        
        if (status.gmail_connected && status.gmail_account) {
          // Show connected status
          $("#email-status-badge").textContent = "‚úì Gmail Connected";
          $("#email-status-badge").className = "badge";
          $("#email-status-badge").style.background = "#ecfdf5";
          $("#email-status-badge").style.color = "#16a34a";
          $("#email-data-source").innerHTML = `
            üìß <b>${status.gmail_account.email}</b> 
            <span style="color:var(--muted);">¬∑ ${status.gmail_account.messages_total} messages ¬∑ Engine: ${status.model_type}</span>
          `;
          
          // Show Gmail account info card
          $("#gmail-account-info").classList.remove("hide");
          $("#gmail-email-display").textContent = status.gmail_account.email;
          $("#gmail-messages-count").textContent = status.gmail_account.messages_total.toLocaleString();
        } else {
          // Show mock mode status
          $("#email-status-badge").textContent = "‚ö† Mock Mode";
          $("#email-status-badge").className = "badge";
          $("#email-status-badge").style.background = "#fff7ed";
          $("#email-status-badge").style.color = "#d97706";
          $("#email-data-source").textContent = `Source: ${status.data_source} ¬∑ Engine: ${status.model_type}`;
          
          // Hide Gmail account info card
          $("#gmail-account-info").classList.add("hide");
        }
        
        $("#email-model-badge").textContent = status.model_type;
      } catch(err) {
        console.error('Failed to load email status:', err);
      }
    }

    async function loadEmailSummary() {
      try {
        const resp = await fetch(`${resolveBackendOrigin()}/api/risk-summary`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        const summary = await resp.json();
        emailData.summary = summary;
        
        $("#em-total").textContent = summary.total_emails;
        $("#em-suspicious").textContent = summary.suspicious_emails;
        $("#em-high-risk").textContent = summary.high_risk_emails;
        
        $("#risk-low").textContent = summary.by_risk_level.low || 0;
        $("#risk-medium").textContent = summary.by_risk_level.medium || 0;
        $("#risk-high").textContent = summary.by_risk_level.high || 0;
        
        $("#cat-phishing").textContent = summary.by_category.phishing || 0;
        $("#cat-spam").textContent = summary.by_category.spam || 0;
        $("#cat-malware").textContent = summary.by_category.malware || 0;
        $("#cat-normal").textContent = summary.by_category.normal || 0;
        
        if(summary.total_emails > 0) {
          // Detection rate = (Medium + High risk emails) / Total emails
          const mediumCount = summary.by_risk_level.medium || 0;
          const highCount = summary.by_risk_level.high || 0;
          const rate = ((mediumCount + highCount) / summary.total_emails * 100).toFixed(1);
          $("#em-detection-rate").textContent = rate + "%";
        }
      } catch(err) {
        console.error('Failed to load email summary:', err);
      }
    }

    async function loadEmailThreats() {
      try {
        console.log('[loadEmailThreats] Fetching threats...');
        const resp = await fetch(`${resolveBackendOrigin()}/api/suspicious-emails?limit=100&min_risk_score=0.0`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        const data = await resp.json();
        console.log('[loadEmailThreats] Received data:', data);
        emailData.threats = data.items || [];
        console.log('[loadEmailThreats] Total threats:', emailData.threats.length);
        
        const container = $("#email-threats-list");
        if(!emailData.threats || emailData.threats.length === 0) {
          console.log('[loadEmailThreats] No threats found, showing message');
          container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">‚úÖ No suspicious emails found</p>';
          return;
        }
        
        console.log('[loadEmailThreats] Rendering', emailData.threats.length, 'threat cards');
        
        // Filter out low-risk emails
        const filteredThreats = emailData.threats.filter(email => email.risk_level !== 'low');
        
        if (filteredThreats.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">‚úÖ No medium or high risk emails found</p>';
          return;
        }
        
        container.innerHTML = '';
        filteredThreats.forEach((email, idx) => {
          const card = document.createElement('div');
          card.className = 'result';
          card.style.marginBottom = '12px';
          card.style.cursor = 'pointer';
          card.onclick = () => {
            const details = card.querySelector('.email-details');
            details.classList.toggle('hide');
          };
          
          const levelClass = email.risk_level === 'high' ? 'danger' : (email.risk_level === 'medium' ? 'suspicious' : 'safe');
          const categoryIcon = email.category === 'phishing' ? 'üé£' : (email.category === 'spam' ? 'üìÆ' : 'ü¶†');
          
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;">
              <div style="flex:1;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                  <span class="pill ${levelClass}" style="font-weight:600;">${email.risk_level.toUpperCase()}</span>
                  <span class="chip">${categoryIcon} ${email.category}</span>
                  <span style="font-size:12px;color:var(--muted);">${new Date(email.date).toLocaleString('en-US')}</span>
                </div>
                <h3 style="margin:0 0 6px 0;font-size:15px;font-weight:600;">${email.subject}</h3>
                <div style="font-size:13px;color:var(--muted);">üìß ${email.sender}</div>
              </div>
              <div style="text-align:right;margin-left:16px;">
                <div style="font-size:24px;font-weight:700;color:${email.risk_level === 'high' ? 'var(--danger)' : 'var(--warn)'};">
                  ${(email.risk_score * 100).toFixed(0)}
                </div>
                <div style="font-size:11px;color:var(--muted);">Risk Score</div>
              </div>
            </div>
            <div class="email-details hide" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
              <div style="background:#f9fafb;padding:10px;border-radius:8px;">
                <b style="font-size:13px;">üîç Detected Risk Indicators:</b>
                <ul class="list" style="margin-top:8px;font-size:13px;">
                  ${(() => {
                    try {
                      const reasons = typeof email.reasons === 'string' ? JSON.parse(email.reasons) : (Array.isArray(email.reasons) ? email.reasons : []);
                      return reasons.map(r => `<li><span>‚ñ∏ ${r}</span><span></span></li>`).join('');
                    } catch(e) {
                      return '<li><span>‚ñ∏ Risk indicators detected</span></li>';
                    }
                  })()}
                </ul>
              </div>
              <div style="margin-top:10px;font-size:12px;color:var(--muted);">
                <b>Recommended Action:</b> ${email.risk_level === 'high' ? 'Delete immediately, do not click any links' : 'Verify sender identity before taking action'}
              </div>
            </div>
          `;
          container.appendChild(card);
        });
        
        state.scans++;
        state.alerts.push(`Email scan: ${data.items.length} threats detected`);
        rerenderKPIs();
      } catch(err) {
        console.error('Failed to load email threats:', err);
        const container = $("#email-threats-list");
        // Only show error if there's actually an error (not just empty data)
        if (err.message.includes('HTTP')) {
          container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;color:#dc2626;">‚ö†Ô∏è Connection error. Please ensure backend is running on port 8000</p>';
        } else {
          container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">üìä Click "Start Scan" or "Test Data (50)" to begin analysis</p>';
        }
      }
    }

    async function loadReportData() {
      try {
        // Load email summary for reports
        const resp = await fetch(`${resolveBackendOrigin()}/api/risk-summary`);
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        const summary = await resp.json();
        
        // Update state with real data
        state.scans = summary.total_emails || 0;
        state.urls = summary.suspicious_emails || 0;
        state.senders = summary.high_risk_emails || 0;
        state.deepfakes = 0; // Not implemented yet
        
        // Generate alerts from email data
        if (summary.high_risk_emails > 0) {
          state.alerts.push(`Email scan: ${summary.high_risk_emails} high-risk threats detected`);
        }
        if (summary.suspicious_emails > 0) {
          state.alerts.push(`Email scan: ${summary.suspicious_emails} suspicious emails found`);
        }
        
        // Get top risky senders
        const threatsResp = await fetch(`${resolveBackendOrigin()}/api/suspicious-emails?limit=10&min_risk_score=0.5`);
        if (threatsResp.ok) {
          const threatsData = await threatsResp.json();
          const senderCounts = {};
          threatsData.items.forEach(email => {
            senderCounts[email.sender] = (senderCounts[email.sender] || 0) + 1;
          });
          state.email.senders = Object.entries(senderCounts)
            .map(([name, count]) => ({name, count}))
            .sort((a, b) => b.count - a.count)
            .slice(0, 5);
        }
        
        state.email.new = summary.total_emails || 0;
        state.email.sus = summary.suspicious_emails || 0;
        state.email.blk = summary.high_risk_emails || 0;
        
        // Update UI
        rerenderKPIs();
      } catch(err) {
        console.error('Failed to load report data:', err);
      }
    }

    async function performScan(limit) {
      // Show progress bar
      $("#scan-progress-container").classList.remove("hide");
      $("#scan-progress-text").textContent = "Clearing old data...";
      $("#scan-progress-percent").textContent = "0%";
      $("#scan-progress-bar").style.width = "0%";
      
      // Disable buttons
      $("#btn-scan-emails").disabled = true;
      $("#btn-scan-all").disabled = true;
      
      try {
        // Auto clear database first
        $("#scan-progress-bar").style.width = "10%";
        $("#scan-progress-percent").textContent = "10%";
        await fetch(`${resolveBackendOrigin()}/api/clear-database`, { method: "DELETE" });
        
        // Update progress: fetching
        $("#scan-progress-text").textContent = `Fetching ${limit} emails from Gmail...`;
        $("#scan-progress-percent").textContent = "30%";
        $("#scan-progress-bar").style.width = "30%";
        
        const resp = await fetch(`${resolveBackendOrigin()}/api/scan`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ limit: limit })
        });
        
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        
        // Update progress: analyzing
        $("#scan-progress-text").textContent = `Analyzing emails with AI model...`;
        $("#scan-progress-percent").textContent = "65%";
        $("#scan-progress-bar").style.width = "60%";
        
        const result = await resp.json();
        
        // Update progress: saving
        $("#scan-progress-text").textContent = `Saving ${result.inserted} new records...`;
        $("#scan-progress-percent").textContent = "80%";
        $("#scan-progress-bar").style.width = "80%";
        
        await new Promise(r => setTimeout(r, 500)); // Small delay for UX
        
        // Update progress: refreshing
        $("#scan-progress-text").textContent = "Refreshing dashboard...";
        $("#scan-progress-percent").textContent = "95%";
        $("#scan-progress-bar").style.width = "95%";
        
        await loadEmailStatus();
        await loadEmailSummary();
        await loadEmailThreats();
        
        // Complete
        $("#scan-progress-text").textContent = `‚úÖ Scan completed! Scanned: ${result.scanned}, New: ${result.inserted}`;
        $("#scan-progress-percent").textContent = "100%";
        $("#scan-progress-bar").style.width = "100%";
        
        await new Promise(r => setTimeout(r, 2000)); // Show success for 2s
        $("#scan-progress-container").classList.add("hide");
        
      } catch(err) {
        console.error('Scan failed:', err);
        $("#scan-progress-text").textContent = `‚ùå Scan failed: ${err.message}`;
        $("#scan-progress-percent").textContent = "Error";
        await new Promise(r => setTimeout(r, 3000));
        $("#scan-progress-container").classList.add("hide");
      } finally {
        $("#btn-scan-emails").disabled = false;
        $("#btn-scan-all").disabled = false;
      }
    }

    $("#btn-scan-emails").addEventListener("click", async ()=>{
      const limit = parseInt($("#scan-limit").value) || 100;
      if (limit < 10 || limit > 500) {
        alert("Please enter a number between 10 and 500");
        return;
      }
      await performScan(limit);
    });

    $("#btn-scan-all").addEventListener("click", async ()=>{
      if (!confirm("‚ö†Ô∏è Scan ALL emails (500)? This may take several minutes.")) {
        return;
      }
      await performScan(500);
    });

    $("#btn-load-test-data").addEventListener("click", async ()=>{
      const btn = $("#btn-load-test-data");
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "‚è≥ Loading...";
      
      // Show progress bar
      const progressContainer = $("#scan-progress-container");
      progressContainer.classList.remove("hide");
      $("#scan-progress-text").textContent = "Clearing old data...";
      $("#scan-progress-percent").textContent = "0%";
      $("#scan-progress-bar").style.width = "0%";
      
      try {
        // Auto clear database first
        $("#scan-progress-bar").style.width = "15%";
        $("#scan-progress-percent").textContent = "15%";
        await fetch("/api/clear-database", { method: "DELETE" });
        
        // Animate progress
        $("#scan-progress-text").textContent = "Loading test data...";
        $("#scan-progress-bar").style.width = "30%";
        $("#scan-progress-percent").textContent = "30%";
        
        const res = await fetch("/api/load-test-data", {
          method: "POST",
          headers: {"Content-Type": "application/json"}
        });
        
        $("#scan-progress-bar").style.width = "70%";
        $("#scan-progress-percent").textContent = "70%";
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Failed to load test data");
        }
        
        const data = await res.json();
        
        // Complete progress
        $("#scan-progress-bar").style.width = "100%";
        $("#scan-progress-percent").textContent = "100%";
        $("#scan-progress-text").textContent = `‚úì Loaded ${data.scanned} test emails`;
        
        // Refresh dashboard
        await loadEmailSummary();
        await loadEmailThreats();
        
        // Show success message in progress bar for 2 seconds, then hide
        setTimeout(() => {
          progressContainer.classList.add("hide");
        }, 2000);
      } catch (err) {
        console.error("Load test data error:", err);
        $("#scan-progress-text").textContent = `‚úó Failed: ${err.message}`;
        setTimeout(() => {
          progressContainer.classList.add("hide");
        }, 3000);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });



    // Export button (optional - only exists on some pages)
    const btnExport = $("#btn-export");
    if (btnExport) {
      btnExport.addEventListener("click", ()=>{
        const csv = "sender,count\n" + state.email.senders.map(s=>`${s.name},${s.count}`).join("\n");
        const blob = new Blob([csv], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "risky_senders.csv"; a.click();
        URL.revokeObjectURL(url);
      });
    }

    // Deepfake demo
    let dfImageData = null;
    $("#df-file").addEventListener("change", (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        dfImageData = reader.result;
        $("#df-img").src = dfImageData;
        $("#df-preview").classList.remove("hide");
        $("#df-level").className = "pill"; $("#df-level").textContent = "‚Äî";
        $("#df-score").textContent = "‚Äî";
        $("#df-findings").innerHTML = '<li><span class="muted">Ready to analyze</span><span></span></li>';
      };
      reader.readAsDataURL(f);
    });

    $("#btn-df-analyze").addEventListener("click", async ()=>{
      if(!dfImageData){ alert("Please upload an image first."); return; }
      
      const btn = $("#btn-df-analyze");
      btn.disabled = true;
      btn.textContent = "Analyzing...";
      
      try {
        // Ëé∑ÂèñÂÆûÈôÖÁöÑÊñá‰ª∂ÂØπË±°
        const fileInput = $("#df-file");
        const file = fileInput.files[0];
        
        if (!file) {
          alert("Please select an image file.");
          return;
        }
        
        // Ë∞ÉÁî®ÁúüÂÆûÁöÑÂêéÁ´ØAPI
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('/api/deepfake/detect-image', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Ê†πÊçÆÁúüÂÆûÁªìÊûúÊõ¥Êñ∞UI
        const level = result.risk_level === 'high' ? 'danger' : 
                     result.risk_level === 'medium' ? 'suspicious' : 'safe';
        const conf = (result.confidence / 100).toFixed(2);
        
        const pill = $("#df-level");
        pill.className = "pill " + level;
        pill.textContent = result.is_deepfake ? "LIKELY DEEPFAKE" : 
                          level === "suspicious" ? "UNCERTAIN" : "LIKELY REAL";
        $("#df-score").textContent = conf;
        
        // ÊòæÁ§∫Ê£ÄÊµãÁªìÊûúËØ¶ÊÉÖ
        const findings = [];
        if (result.is_deepfake) {
          findings.push(`Detected as AI-generated (${result.prediction})`);
          findings.push(`Fake probability: ${result.probabilities.fake}%`);
          findings.push(`Real probability: ${result.probabilities.real}%`);
        } else {
          findings.push(`Detected as real face`);
          findings.push(`Real probability: ${result.probabilities.real}%`);
          findings.push(`Fake probability: ${result.probabilities.fake}%`);
        }
        
        const ul = $("#df-findings");
        ul.innerHTML = "";
        findings.forEach(f=>{
          const li = document.createElement("li");
          li.innerHTML = `<span>${f}</span><span></span>`;
          ul.appendChild(li);
        });
        
        state.scans++; 
        state.deepfakes += result.is_deepfake ? 1 : 0;
        if(result.is_deepfake) state.alerts.push(`Deepfake detected (${result.risk_level})`);
        rerenderKPIs();
        
      } catch (error) {
        console.error("Deepfake detection error:", error);
        alert("Failed to analyze image: " + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Analyze";
      }
    });

    $("#btn-df-clear").addEventListener("click", ()=>{
      dfImageData = null;
      $("#df-file").value = "";
      $("#df-preview").classList.add("hide");
    });

    // Reports JSON
    $("#btn-json").addEventListener("click", ()=>{
      const payload = {
        scans: state.scans, urls: state.urls, senders: state.senders, deepfakes: state.deepfakes,
        alerts: state.alerts.slice(-20),
        email: state.email
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "safeguard_report.json"; a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
